<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RatingWatch</title>
    <!-- BootstrapのCSS読み込み -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery読み込み -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!--Chart.js読み込み-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

    <!-- BootstrapのJS読み込み -->
    <script src="js/bootstrap.min.js"></script>
    <!-- jquery.xdomainajax.js -->
    <!-- scriptタグも含むよう改造 -->
    <script src="js/jquery.xdomainajax.js"></script>

    <link rel="stylesheet" href="./css/simple-sidebar.css" />
    <link rel="stylesheet" href="./css/my.css" />
    
    <script type="text/javascript">
      function scrapingAtcoder(userid) {
        $.ajax({
          type: 'GET',
          url: "https://atcoder.jp/user/" + userid,
          dataType: 'html',
          success: function(data) {
            var src = data.responseText;
            var jsonStr = getAtcoderJSON(src);
            if (jsonStr == null) {
              alert("ユーザ名が空，もしくは間違っています");
              return;
            }
            var rating_history = JSON.parse(jsonStr);
            console.log(rating_history[0][1]);
            drawGraph(rating_history, userid);
          }, error:function(e) {
            console.log(e);
          }
        });
      }

      function getAtcoderJSON(src) {
        var idxf = src.indexOf('JSON.parse("');
        var idxe = src.indexOf('");]]>', idxf);
        if (idxf != -1 && idxe != -1) {
          // バックスラッシュ(円マーク)取り除かないとダメ
          return src.slice(idxf + 12, idxe).replace(/\\/g, "");
        }
        return null;
      }

      $(document).ready(function retrieveGETqs() {
        var query = window.location.search.substring(1);
        var parms = query.split('&');
        var names = parms[0].slice(parms[0].indexOf('=') + 1).split('+');
        console.log(names);
        for (var i = 0; i < names.length; ++i) {
          console.log(names[i]);
          if (names[i] != "") {
            scrapingAtcoder(names[i]);
          }
        }
        console.log("hoge");
      });

      function drawGraph(rating_history, name) {
        var ctx = document.getElementById('myChart').getContext('2d');
        ctx.canvas.width = 750;         //グラフのwidth
        ctx.canvas.height = 500;        //グラフのheight
        var m = rating_history.length;
        var contest = [rating_history[m - 1][3]];
        var rating = [rating_history[m - 1][1]];
        Chart.defaults.global.elements.line.tension = 0;    //グラフを直線に
        for (var i = 1; i < m; i++){
          contest.push(rating_history[m - i][3]);
          rating.push(rating_history[m - i][1])
        }
        var myChart = new Chart(ctx, {
          type: 'line',           //グラフの種類
          data: {
            labels: contest,   //グラフの項目名(contest)
            datasets: [{
              label: name,        //グラフの名前(name)
              data: rating,     //項目のデータ(rating)
              backgroundColor: "rgba(153,255,51,0.4)"   //線の下の色
            }]
          },
          options: {
            responsive: false
          }
        });
      }

    </script>
  </head>

  <body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-full navbar-fixed-top navbar-inverse">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand">RatingWatch</a>
        </div>
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Atcoder</a></li>
          <li class="active"><a href="#">Topcoder</a></li>
          <li class="active"><a href="#">Codeforces</a></li>
        </ul>
      </div>
    </nav>

    <div id="wrapper">
      <!-- サイドバー -->
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="#">
              Atcoder
            </a>
          </li>
          <div class="form-inline">
            <form method="GET">
              <!-- ID入力フォーム -->
              <input type="text" class="form-control" name="usr" id="atcoderid" placeholder="User ID" />
              <!-- Showボタン -->
              <!--<button type="button" class="btn btn-success" id="show" onclick="scrapingAtcoder()">Show</button>-->
              <input type="submit" value="Show" class="btn btn-secondary user-form" data-disable-with="Show" />
              <!--
              <script>
                $(function(){
                  $("input").keydown(function(e){
                    if ((e.which && e.whitch === 13) || (e.keyCode && e.keyCode === 13)) {
                      scrapingAtcoder();
                      return false;
                    } else {
                      return true;
                    }
                  });
                });
              </script>
              -->
            </form>
          </div>
        </ul>
      </div>

      <!-- 本文 -->
      <div id="page-content-wrapper">
        <div class="cotainer-fluid">
          <div class="row">
            <div class="col-lg-12">
              <p>Shinobu</p>
              <canvas id="myChart"></canvas> <!--グラフ描写領域-->
            </div>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
