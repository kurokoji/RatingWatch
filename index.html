<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RatingWatch</title>
    <!-- BootstrapのCSS読み込み -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery読み込み -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!--Chart.js読み込み-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

    <!-- BootstrapのJS読み込み -->
    <script src="js/bootstrap.min.js"></script>
    <!-- jquery.xdomainajax.js -->
    <!-- scriptタグも含むよう改造 -->
    <script src="js/jquery.xdomainajax.js"></script>

    <link rel="stylesheet" href="./css/simple-sidebar.css" />
    <link rel="stylesheet" href="./css/my.css" />
    
    <script type="text/javascript">
      function scrapingAtcoder(userid, cb) {
        $.ajax({
          type: 'GET',
          url: "https://atcoder.jp/user/" + userid,
          dataType: 'html',
          success: function(data) {
            var src = data.responseText;
            var jsonStr = getAtcoderJSON(src);
            if (jsonStr == null) {
              alert("ユーザ名が空，もしくは間違っています");
              return;
            }
            var rating_history = JSON.parse(jsonStr);
            cb(rating_history);
          }, error:function(e) {
            console.log(e);
          }
        });
      }

      function getAtcoderJSON(src) {
        var idxf = src.indexOf('JSON.parse("');
        var idxe = src.indexOf('");]]>', idxf);
        if (idxf != -1 && idxe != -1) {
          // バックスラッシュ(円マーク)取り除かないとダメ
          return src.slice(idxf + 12, idxe).replace(/\\/g, "");
        }
        return null;
      }

      $(document).ready(function retrieveGETqs() {
        var query = window.location.search.substring(1);
        var parms = query.split('&');
        var names = parms[0].slice(parms[0].indexOf('=') + 1).split('+');
        console.log(names);
        if (names.length == 1){
          scrapingAtcoder(names[0], function(user){
            var rating = [user];
            drawGraph(rating, names);
          });
        }
        if (names.length == 2){
          scrapingAtcoder(names[0], function(user1){
            scrapingAtcoder(names[1], function(user2){
              var rating = [user1, user2];
              drawGraph(rating, names);
            });
          });
        }
      });


      function drawGraph(rating_history, name) {
        var ctx = document.getElementById('myChart').getContext('2d');
        ctx.canvas.width = 750;         //グラフのwidth
        ctx.canvas.height = 500;        //グラフのheight
        console.log(rating_history[0][0]);
        Chart.defaults.global.elements.line.tension = 0;    //グラフを直線に

        var contest = [];

        if (name.length == 2){
          var rating_merge = [];
          var rating1 = [], rating2 = [];
          
          for (var e of rating_history[0]) rating_merge.push([e[0], e[3]]);
          for (var e of rating_history[1]) rating_merge.push([e[0], e[3]]);

          var r = rating_merge.filter(function(v, idx, s) {
            for (var i = 0; i < s.length; ++i) {
              if (v[0] === s[i][0]) {
                return i === idx;
              }
            }
            return false;
          });
          console.log(r[0]);

          r.sort(function(lhs, rhs) {
            if (lhs[0] > rhs[0]) {
              return 1;
            } else {
              return -1;
            }
          });
          console.log(r);
          for (var e of r) {
            contest.push(
              e[1].replace(/AtCoder Grand Contest/g, 'AGC').
              replace(/AtCoder Regular Contest/g, 'ARC').
              replace(/AtCoder Beginner Contest/g, 'ABC')
            );
          }
          var max_rate = -1;
          for (var e of r) {
            var flg = true;
            for (var t of rating_history[0]) {
              if (e[0] === t[0]) {
                max_rate = Math.max(max_rate, t[1]);
                rating1.push(t[1]);
                flg = false;
              }
            }
            if (flg && rating1.length === 0) {
              rating1.push(null);
            } else if (flg) {
              rating1.push(rating1[rating1.length - 1]);
            }
          }

          for (var e of r) {
            var flg = true;
            for (var t of rating_history[1]) {
              if (e[0] === t[0]) {
                max_rate = Math.max(max_rate, t[1]);
                rating2.push(t[1]);
                flg = false;
              }
            }
            if (flg && rating2.length === 0) {
              rating2.push(null);
            } else if (flg) {
              rating2.push(rating2[rating2.length - 1]);
            }
          }


          var myChart = new Chart(ctx, {
            type: 'line',           //グラフの種類
            data: {
              labels: contest,   //グラフの項目名(contest)
              datasets: [{
                label: name[0],        //グラフの名前(name)
                data: rating1,     //項目のデータ(rating)
                backgroundColor: "rgba(153,255,51,0.4)"   //線の下の色
              },
              {
                label: name[1],
                data: rating2,
                backgroundColor: "rgba(219,36,91,0.4)"
              }]
            },
            options: {
              scales: {
                yAxes: [
                  {
                    ticks: {
                      beginAtZero: true,
                      min: 0,
                      max: Math.ceil(max_rate / 1000) * 1000
                    }
                  }
                ]
              },
              responsive: false,
            }
          });
        } else {
          var m = rating_history[0].length;
        
          var contest = [];
          var rating = [];
          var max_rate = -1;
          for (var i = 1; i < m; i++){
            contest.push(rating_history[0][m - i][3].
              replace(/AtCoder Grand Contest/g, 'AGC').
              replace(/AtCoder Regular Contest/g, 'ARC').
              replace(/AtCoder Beginner Contest/g, 'ABC')
            );
            max_rate = Math.max(max_rate, rating_history[0][m - i][1]);
            rating.push(rating_history[0][m - i][1])
          }
          var myChart = new Chart(ctx, {
            type: 'line',           //グラフの種類
            data: {
              labels: contest,   //グラフの項目名(contest)
              datasets: [{
                label: name,        //グラフの名前(name)
                data: rating,     //項目のデータ(rating)
                backgroundColor: "rgba(153,255,51,0.4)"   //線の下の色
              }]
            },
            options: {
              scales: {
                yAxes: [
                  {
                    ticks: {
                      beginAtZero: true,
                      min: 0,
                      max: Math.ceil(max_rate / 1000) * 1000
                    }
                  }
                ]
              },
              responsive: false,
            }
          });
        }
      }
    </script>
  </head>

  <body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-full navbar-fixed-top navbar-inverse">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand">RatingWatch</a>
        </div>
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Atcoder</a></li>
          <li class="active"><a href="#">Topcoder</a></li>
          <li class="active"><a href="#">Codeforces</a></li>
        </ul>
      </div>
    </nav>

    <div id="wrapper">
      <!-- サイドバー -->
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="#">
              Atcoder
            </a>
          </li>
          <div class="form-inline">
            <form method="GET">
              <!-- ID入力フォーム -->
              <input type="text" class="form-control" name="usr" id="atcoderid" placeholder="User ID" />
              <!-- Showボタン -->
              <input type="submit" value="Show" class="btn btn-secondary user-form" data-disable-with="Show" />
            </form>
          </div>
        </ul>
      </div>

      <!-- 本文 -->
      <div id="page-content-wrapper">
        <div class="cotainer-fluid">
          <div class="row">
            <div class="col-lg-12">
              <p>Shinobu</p>
              <canvas id="myChart"></canvas> <!--グラフ描写領域-->
            </div>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>